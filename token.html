<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div id="topics">
    <div class="post">
        <h1 class="postTitle">
            php token
        </h1>
        <div class="clear"></div>
        <div class="postBody">

            <div id="cnblogs_post_body" class="blogpost-body ">
                <p>接口特点汇总：</p>
                <p>1、因为是非开放性的，所以所有的接口都是封闭的，只对公司内部的产品有效；</p>
                <p>2、因为是非开放性的，所以OAuth那套协议是行不通的，因为没有中间用户的授权过程；</p>
                <p>3、有点接口需要用户登录才能访问；</p>
                <p>4、有点接口不需要用户登录就可访问</p>
                <p>&nbsp;</p>
                <p>针对以上特点，移动端与服务端的通信就需要2把钥匙，即2个token。</p>
                <p>第一个token是针对接口的（api_token）；</p>
                <p>第二个token是针对用户的（user_token）；</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p><strong>先说第一个token（api_token）</strong></p>
                <p>&nbsp;</p>
                <p>它的职责是保持接口访问的隐蔽性和有效性，保证接口只能给自家人用，怎么做到？参考思路如下：</p>
                <p>现在的接口基本是mvc模式，URL基本是restful风格，URL大体格式如下：</p>
                <p>http://blog.snsgou.com/模块名/控制器名/方法名?参数名1=参数值1&amp;参数名2=参数值2&amp;参数名3=参数值3</p>
                <p>&nbsp;</p>
                <p>接口token生成规则参考如下：</p>
                <p>api_token = md5 ('模块名' + '控制器名' + '方法名' + '2013-12-18' + '加密密钥') = 770fed4ca2aabd20ae9a5dd774711de2</p>
                <p>其中的&nbsp;</p>
                <p>1、 '2013-12-18' 为当天时间，</p>
                <p>2、'加密密钥' 为私有的加密密钥，手机端需要在服务端注册一个“接口使用者”账号后，系统会分配一个账号及密码，数据表设计参考如下：</p>
                <table border="1" cellspacing="1" cellpadding="1">
                    <tbody>
                    <tr>
                        <td>字段名</td>
                        <td>字段类型</td>
                        <td>注释</td>
                    </tr>
                    <tr>
                        <td>client_id</td>
                        <td>varchar(20)</td>
                        <td>客户端ID</td>
                    </tr>
                    <tr>
                        <td>client_secret</td>
                        <td>varchar(20)</td>
                        <td>客户端(加密)密钥</td>
                    </tr>
                    </tbody>
                </table>
                <p>（注：只列出了核心字段，其它的再扩展吧！！！）</p>
                <p>服务端接口校验，PHP实现流程如下：</p>
                <div id="highlighter_899325" class="syntaxhighlighter  ">
                    <div class="lines">
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>01</code></td>
                                    <td class="content"><code class="plain">&lt;?php</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>02</code></td>
                                    <td class="content"><code class="comments">// 1、获取 GET参数 值</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>03</code></td>
                                    <td class="content"><code class="variable">$module</code>&nbsp;<code class="plain">=&nbsp;</code><code class="variable">$_GET</code><code class="plain">[</code><code class="string">'mod'</code><code class="plain">];</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>04</code></td>
                                    <td class="content"><code class="variable">$controller</code>&nbsp;<code class="plain">=&nbsp;</code><code class="variable">$_GET</code><code class="plain">[</code><code class="string">'ctl'</code><code class="plain">]</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>05</code></td>
                                    <td class="content"><code class="variable">$action</code>&nbsp;<code class="plain">=&nbsp;</code><code class="variable">$_GET</code><code class="plain">[</code><code class="string">'act'</code><code class="plain">];</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>06</code></td>
                                    <td class="content"><code class="variable">$client_id</code>&nbsp;<code class="plain">=&nbsp;</code><code class="variable">$_GET</code><code class="plain">[</code><code class="string">'client_id'</code><code class="plain">];</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>07</code></td>
                                    <td class="content"><code class="variable">$api_token</code>&nbsp;<code class="plain">=&nbsp;</code><code class="variable">$_GET</code><code class="plain">[</code><code class="string">''</code><code class="plain">api_token];</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>08</code></td>
                                    <td class="content">&nbsp;</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>09</code></td>
                                    <td class="content"><code class="comments">// 2、根据客户端传过来的 client_id ，查询数据库，获取对应的 client_secret</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>10</code></td>
                                    <td class="content"><code class="variable">$client_secret</code>&nbsp;<code class="plain">= getClientSecretById(</code><code class="variable">$client_id</code><code class="plain">);</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>11</code></td>
                                    <td class="content">&nbsp;</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>12</code></td>
                                    <td class="content"><code class="comments">// 3、服务端重新生成一份 api_token</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>13</code></td>
                                    <td class="content"><code class="variable">$api_token_server</code>&nbsp;<code class="plain">= md5(</code><code class="variable">$module</code>&nbsp;<code class="plain">.&nbsp;</code><code class="variable">$controller</code>&nbsp;<code class="plain">.&nbsp;</code><code class="variable">$action</code>&nbsp;<code class="plain">.&nbsp;&nbsp;</code><code class="functions">date</code><code class="plain">(</code><code class="string">'Y-m-d'</code><code class="plain">, time()) .&nbsp;&nbsp;</code><code class="variable">$client_secret</code><code class="plain">);</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>14</code></td>
                                    <td class="content">&nbsp;</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>15</code></td>
                                    <td class="content"><code class="comments">// 4、客户端传过来的 api_token 与服务端生成的 api_token 进行校对，如果不相等，则表示验证失败</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>16</code></td>
                                    <td class="content"><code class="keyword">if</code>&nbsp;<code class="plain">(</code><code class="variable">$api_token</code>&nbsp;<code class="plain">!=&nbsp;</code><code class="variable">$api_token_server</code><code class="plain">) {</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>17</code></td>
                                    <td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">exit</code><code class="plain">(</code><code class="string">'access deny'</code><code class="plain">);&nbsp;&nbsp;</code><code class="comments">// 拒绝访问</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>18</code></td>
                                    <td class="content"><code class="plain">}</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>19</code></td>
                                    <td class="content">&nbsp;</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>20</code></td>
                                    <td class="content"><code class="comments">// 5、验证通过，返回数据给客户端</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt1">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>21</code></td>
                                    <td class="content"><code class="comments">//。。。</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="line alt2">
                            <table>
                                <tbody>
                                <tr>
                                    <td class="number"><code>22</code></td>
                                    <td class="content"><code class="plain">?&gt;</code></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <p>&nbsp;</p>
                <p><strong>再说第二个token（user_token）</strong></p>
                <p>&nbsp;</p>
                <p>它的职责是保护用户的用户名及密码多次提交，以防密码泄露。</p>
                <p>如果接口需要用户登录，其访问流程如下：</p>
                <p>1、用户提交“用户名”和“密码”，实现登录（条件允许，这一步最好走https）；</p>
                <p>2、登录成功后，服务端返回一个 user_token，生成规则参考如下：</p>
                <p>服务端用数据表维护user_token的状态，表设计如下：</p>
                <table border="1" cellspacing="1" cellpadding="1">
                    <tbody>
                    <tr>
                        <td>字段名</td>
                        <td>字段类型</td>
                        <td>注释</td>
                    </tr>
                    <tr>
                        <td>user_id</td>
                        <td>int</td>
                        <td>用户ID</td>
                    </tr>
                    <tr>
                        <td>user_token</td>
                        <td>varchar(36)</td>
                        <td>用户token</td>
                    </tr>
                    <tr>
                        <td>expire_time</td>
                        <td>int</td>
                        <td>过期时间（Unix时间戳）</td>
                    </tr>
                    </tbody>
                </table>
                <p>（注：只列出了核心字段，其它的再扩展吧！！！）</p>
                <p>服务端生成 user_token 后，返回给客户端（自己存储），客户端每次接口请求时，如果接口需要用户登录才能访问，则需要把 user_id 与 user_token 传回给服务端，服务端接受到这2个参数后，需要做以下几步：</p>
                <p>1、检测 api_token的有效性；</p>
                <p>2、删除过期的 user_token 表记录；</p>
                <p>3、根据 user_id，user_token 获取表记录，如果表记录不存在，直接返回错误，如果记录存在，则进行下一步；</p>
                <p>4、更新 user_token 的过期时间（延期，保证其有效期内连续操作不掉线）；</p>
                <p>5、返回接口数据；</p>
                <p>&nbsp;</p>
                <p><strong>接口用例如下：</strong></p>
                <p>&nbsp;</p>
                <p>1、发布日志</p>
                <p>URL： &nbsp;http://blog.snsgou.com/blog/Index/addBlog?client_id=wt3734wy636dhd3636sr5858t6&amp;api_token=880fed4ca2aabd20ae9a5dd774711de2&amp;user_token=etye0fgkgk4ca2aabd20ae9a5dd77471fgf&amp;user_id=12</p>
                <p>请求方式： &nbsp;POST</p>
                <p>POST参数：title=我是标题&amp;content=我是内容</p>
                <p>返回数据：</p>
                <blockquote>
                    <p>{<br>&nbsp; &nbsp; &nbsp; 'code' =&gt; 1, // 1:成功 0:失败<br>&nbsp; &nbsp; &nbsp; 'msg' =&gt; '操作成功' // 登录失败、无权访问<br>&nbsp; &nbsp; &nbsp; 'data' =&gt; []<br>}</p>

                </blockquote>
            </div>
            <div id="MySignature"></div>
            <div class="clear"></div>
            <div id="blog_post_info_block">


                <div class="clear"></div>
            </div>
        </div>

    </div>


</div>
</body>
</html>